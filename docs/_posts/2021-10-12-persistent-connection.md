---
layout: post
title:  "App切到后台就断网，Android手机这个BUG如何克服？"
date:   2021-10-12 15:20:05 +0800
categories: android
typora-copy-images-to: ../asserts
typora-root-url: ../
---

App采用的Websocket长连接和服务器通信，App切到后台3秒就被断网，如何解决？公司的App用来智能家居控制的，控制的成功率是易用的关键。目前用户反馈两个问题：App打开时第一次控制不成功；有时连续多次控制不成功，需要重启App后才能正常。

## 如何调试

App切到后台几秒后，和服务器之间的心跳报文打印没有了，这是就是系统搞得鬼。想要观察到系统对App切到后台时断网现象，需要使用WiFi ADB代替USB进行调试。因为USB连接着的时候属于`充电状态`，充电时`后台断网`不会出现，当使用WiFi ADB的时候可以模拟用户真实使用手机的情况了。

## 硬碰硬
所谓硬碰硬就是保证socket永远不断开，切到后台时也不断开。但是实际情况是如果App不加入系统白名单，就很难在后台长连接不断开（有的手机上术语叫`后台使用数据`）。断开也很有意思，是半断开的情况，你无法感知到Socket已经断开。切到前台时系统会自动再将半断开的Socket再连上App还是无感。这种现象很像现实社会中的一个现象，一时说不上来。

另外网上也有很多例子，我这里不再赘述。
![有帮助的截图](/assets/Selection_269.png)

### 尝试过的方案：

1. 启动线程检测心跳超时后直接重新连接  
   结果是检测线程也会被一起冻结
2. 各种保活方案  
   没能实现
3. 添加到白名单  
   领导不愿意强迫用户手动将App加入白名单，所以和系统硬碰硬方案失败。

## 打太极
在硬碰硬的时候发现，其实友盟的长连接也是在切后台的时候断开，切前台时重连。刚好我遇到的问题还只是`第一次不能控制`问题，用户并不需要后台的时候控制。只需要在App切到前台的时候，快速恢复网络就可以了。在`Activity`的生命周期的地方对`Socket`进行了控制，**切后台时自动断开，切到前台时自动连接上**。方案推出之后，又得到一个反馈，仍然有`第一次不能控的问题`且还有`连续控制无效`的问题。查看日志后得知切前台时0.5秒能连接成功，但是用户手快在0.4秒就控制了，还是控制不成功；另外一种情况是永远处于连接中状态，消息就会一直发不出去。接下来的路就是`继续强化长连接`连接更快和更稳，或者在WS不通的时候改用HTTP补救。前者比较难查，后者服务器改动比较多。两个方案都比较棘手。

如果我安排采用`WS不通的时候改用HTTP补救`方案，同事们就会开始轰轰烈烈动起来，没有一个人反对，但是站在社会工程学角度来看，这也不好。我要反思我的决定是不是正确，因为做错一个决定就会导致架构方向偏离。



## 微信Mars框架

有想过上国民App微信开源的Mars框架，但是现在已经积重难返。


## 最终结果
这次又应对了我总结的理论，`只要下功夫把问题描述清楚，丢到互联网上，答案就自动出现`。通过写本文的过程，我又将流程重新梳理了一下。对于WebSocket的使用上并没有太好。因为结合的状态机分为`Init`,`Auth`,`Communication`等三种大状态。重要命令有`CMD_DISCONNECTED`，发这个命令地方有`网络断开`和``。在`Init`的Enter方法中并调用了`WebSocket`中的`reconnect`，但是其实并没有任何效果。让`reconnect`中强制调用了`stopSocket`，然后再调用`connect`这样就保证了调用稳定性。这样就解决了稳定性的问题。还好结合社会工程学没有把问题搞得更坏。这里适合画个流程图出来，但是目前又开始解决下一个难题了。

![有帮助的截图](/assets/Selection_277.png)